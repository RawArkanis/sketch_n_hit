'use strict';var SERVER_URL='http://localhost:5000';var uid=null;var my_data=null;var friend_list=null;var user_data=null;var match_data=null;$(document).ready(function(){$.ajaxSetup({cache:true});$.getScript('//connect.facebook.net/en_UK/all.js',function(){FB.init({appId:'595127900566216',status:true,cookie:true,xfbml:true,oauth:true});FB.getLoginStatus(onLoginStatus);});});function onLoginStatus(response){var pathname=$(location).attr('pathname');if(response.status==='connected'){uid=response.authResponse.userID;initializeScreen(pathname);}else{if(pathname!=='/index.html'&&pathname!=='/'){$(location).attr('href','index.html');}}}
function login(){FB.login(function(response){if(response.authResponse){$(location).attr('href','matchlist.html');}else{createError({'title':'Oh no!','message':'You may not use this app unless you are'+' logged into Facebook and has given permission to it.'});}});}
function getParameterByName(name){name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return results==null?"":decodeURIComponent(results[1].replace(/\+/g," "));}
function inviteFriends(){FB.ui({method:'apprequests',message:'Come play Sketch\'n\'Hit with me!'},function(){});}
function fadeIn(){$('#lock').fadeIn();}
function fadeOut(){$('#lock').fadeOut();}
function initializeScreen(pathname){switch(pathname){case'/':case'/index.html':break;case'/matchlist.html':createMatchListScreen();break;case'/match.html':var id=getParameterByName('id');createMatchScreen(id);break;case'/draw.html':createDrawScreen();break;case'/hit.html':break;default:createError({'title':'Oh no!','message':'Something is wrong. '+'Try again, please.'});break;}}
function createError(data){$('#container').prepend(error_tmpl(data));}
function createMatchListScreen(){FB.api("/me/friends",{fields:'id, name, picture'},function(response){if(response&&!response.error){friend_list=response.data;if(user_data!==null)
createMatchList();}
else{createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your friend list.'});}});var request=$.ajax({url:SERVER_URL+'/user/'+uid,type:'GET',processData:true,dataType:'json',crossDomain:true,success:function(data){user_data=data;if(friend_list!==null)
createMatchList();},error:function(){createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your match list.'});}});}
function createMatchList(){if(friend_list.length===0){createError({'title':'Oh no!','message':'You have no friends. '+'You need to go out of your cave sometimes.'});return;}
if(user_data.active_matches.length!=0){_.forEach(user_data.active_matches,function(match){var friend=_.find(friend_list,{'id':match.fb_friend_id});var data={'id':match.id,'type':match.type===1?'Drawing':'Hitting','friend_name':friend.name,'friend_picture':friend.picture.data.url,};$('#active').append(matchscreen_tmpl(data));});}
if(user_data.history_matches.length!=0){_.forEach(user_data.history_matches,function(match){var friend=_.find(friend_list,{'id':match.fb_friend_id});var data={'id':match.id,'type':match.type===1?'Drawing':'Hitting','friend_name':friend.name,'friend_picture':friend.picture.data.url,};$('#history').append(matchscreen_tmpl(data));});}
fadeOut();}
function openMatch(id){var result=_.find(user_data.active_matches,{'id':id});if(result!=null){if(result.type===1){$(location).attr('href','match.html?id='+id);}else{$(location).attr('href','hit.html?id='+id);}}else{$(location).attr('href','match.html?id='+id);}}
function createMatchScreen(id){FB.api("/me/friends",{fields:'id, name, picture'},function(response){if(response&&!response.error){friend_list=response.data;if(match_data!==null&&my_data!==null)
createMatch();}
else{createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your friend list.'});}});FB.api("/me",{fields:'id, name, picture'},function(response){if(response&&!response.error){my_data=response;if(match_data!==null&&friend_list!==null)
createMatch();}
else{createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your data.'});}});var request=$.ajax({url:SERVER_URL+'/match/'+id,type:'GET',processData:true,dataType:'json',crossDomain:true,success:function(data){match_data=data;if(friend_list!==null&&my_data!==null)
createMatch();},error:function(){createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your match list.'});}});}
function createMatch(){var sender_name=null;var sender_picture=null;var receiver_name=null;var receiver_picture=null;if(match_data.fb_sender_id===uid){var friend=_.find(friend_list,{'id':match_data.fb_receiver_id});sender_name=my_data.name;sender_picture=my_data.picture.data.url;receiver_name=friend.name;receiver_picture=friend.picture.data.url;}else{var friend=_.find(friend_list,{'id':match_data.fb_sender_id});receiver_name=my_data.name;receiver_picture=my_data.picture.data.url;sender_name=friend.name;sender_picture=friend.picture.data.url;}
var status=null;if(match_data.status===1){status='Active';}else if(match_data.status===2){status='Hit';}else{status='Miss';}
var data={'name':match_data.drawing_name,'sender_name':sender_name,'sender_picture':sender_picture,'receiver_name':receiver_name,'receiver_picture':receiver_picture,'status':status,'tip01':match_data.tip01,'tip02':match_data.tip02,'tip03':match_data.tip03};$('#container').append(match_tmpl(data));fadeOut();}
function createDrawScreen(){FB.api("/me/friends",{fields:'id, name, picture, installed'},function(response){if(response&&!response.error){friend_list=_.filter(response.data,function(friend){return friend.installed==true;});if(friend_list.length===0){createError({'title':'Oh no!','message':'You have no friends playing this game. '+'Please invite someone using the button on MatchList Screen.'});}
buildFriendPicker();var defaultBoard=new DrawingBoard.Board('board',{webStorage:false});fadeOut();}
else{createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when retreaving your friend list.'});}});}
function buildFriendPicker(){_.forEach(friend_list,function(friend){var data={'id':friend.id,'name':friend.name,'picture':friend.picture.data.url};$('#friendlist').prepend(firendlist_tmpl(data));});}
function selectFriend(id){$('#friend_id').val(id);var name=_.find(friend_list,{'id':id}).name;$('#friendinput').val(name);}
function sendDraw(){var friend=$('#friend_id').val();var name=$('#name').val();var tip01=$('#tip01').val();var tip02=$('#tip02').val();var tip03=$('#tip03').val();if(friend===''||name===''||tip01===''||tip02===''||tip03===''){createError({'title':'No no no no no!','message':'You need to fill all the fields before sending. '});return;}
$('#formdraw').get(0).setAttribute('action','http://localhost:5000/match/0');$('#formdraw').get(0).setAttribute('method','POST');$('#user_id').val(uid);var data=$('.board canvas').get(0).toDataURL();$('#data').val(data);var param=$('#formdraw').serialize();fadeIn();var request=$.ajax({url:SERVER_URL+'/match/1',type:'POST',processData:true,data:param,dataType:'json',crossDomain:true,success:function(data){$(location).attr('href','matchlist.html');},error:function(){createError({'title':'Oh no!','message':'Something is wrong. '+'We failed when saving your match.'});}});}